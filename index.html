<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>graveyard's Channel Points Alert</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Francois+One&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400..700&display=swap" rel="stylesheet"><link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="animation.css">
<link rel="icon" type="image/x-icon" href="favicon.ico">
<style>
		#centercontentbox {
			background-color: #09131CCC;
			 border-radius: 11px 11px 26px 11px;
			margin-top: 7px;
			padding: 35px;
			padding-top: 13px;
			backdrop-filter: blur(10px);
			height: 700px;
			width: 360px;
			position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
	overflow: hidden;
		}

        #log {
			margin-top: 20px;
            box-sizing: border-box;
            overflow: auto;
            border: none;
        }

        #log span {
            margin-right: 5px;
        }
		.confetti-wrapper {
		  position: fixed;
			top: 0;
			left: 0;
		  width: 100%;
		  height: 100%;
		  pointer-events: none;
		  overflow: hidden;
		  z-index: 100;	  
		}
		
		.confetti-piece {
		  position: absolute;
          /* Width and height will be set by JS */
		  top: -5%; /* Start above the screen */
		  opacity: 0;
		  animation: confetti-fall ease-out forwards;
		}

		@keyframes confetti-fall {
		  0% {
			transform: translateY(0) rotateZ(0) rotateY(0);
			opacity: 1;
		  }
          85% {
            opacity: 1;
          }
		  100% {
            /* Use variables for dynamic end-points */
			transform: translateY(105vh) rotateZ(var(--rz)) rotateY(var(--ry));
			opacity: 0;
		  }
		}
		#bigcontainer1 {
		  width: 100%;
		  height: 100%;
		  text-align: center;
		  }
	  #bigcontainer {
	  background-image: url('bg.gif');
		text-align: center;
		min-height: 100vh;
		height: auto;
		background-size: cover;
		background-position: center;
	  display: flex;
	  }
    </style>
</head>
<body onClick="playRandomSound();">
<div id="bigcontainer1"><div id="bigcontainer">

			<div id="centercontentbox"><img id="gy-logo" style="float:left; margin-left:-15px;" src="gypoints.png">
                    <span class="description-name text"><a class="logofollow-box" href="https://www.twitch.tv/graveyard420woo" target="_blank"><img id="gy-logo" src="gy.png"></a>Description:</span>
                    <span class="description-main description">This is a tool that shows notifications for Twitch channel points reward redeems!<br>
It will automatically receive any reward's name, background color and image, and display a pop-up alert notification when it's redeemed on your stream. This unpublished version plays random sounds, FUN!<br>

Simply add it as a browser source by copying the URL after you connect your twitch account!</span>
<br>
                    <a id="authorize" class="login-box" target="">
                     <img id="twitch-logo" src="tlogo.png">
                        <span id="twitch-text">Connect Your Twitch!</span>
                    </a>
                    
                    <a class="follow-box" href="https://www.twitch.tv/graveyard420woo" target="_blank">
                     <img id="twitch-logo" src="tlogo.png">
                        <span id="gy-text">Follow graveyard's channel!</span>
                    </a>
                    
                    <span class="description"><br>If this tool helps you along your journey, I am so pleased! I do indie dev work like this to help the universe and everyone in it. It's tough out there, you deserve a simple solution to this.. Feel free to drop a follow on my channel with the above link! </span>
                    
                    <a class="paypal-box" href="https://www.paypal.com/ncp/payment/G7TJ4WR438AJU" target="_blank">
                     <img id="twitch-logo" src="pp.png">
                        <span id="paypal-text">Donate/Tip with Paypal!</span>
                    </a>
                    
                    <span class="description"><br>Just your humble artist/tech (; Always appreciated but never necessary or solicited.</span>

                
                <div style="display: inline;">
                    <div id="log">
                        <div>Click "Connect Your Twitch" above to start!</div>
                    </div> 
                         <br />    
                    <div>Last KeepAlive: <span id="keepalive"></span></div>
                </div>
            </div>

    <script type="text/javascript" src="eventsub.js"></script>
    <script type="text/javascript">
	
        var client_id = 'x0mvw507bahn3c61z73x5psrvntcno';
        var redirect = 'https://graveyard420woo.github.io/GYPoints/';
        var access_token = '';
        var socket_space = '';
        var session_id = '';
        var my_user_id = '';
		var redeemUserColor = '';
								
		document.getElementById('authorize').setAttribute('href', 'https://id.twitch.tv/oauth2/authorize?client_id=' + client_id + '&redirect_uri=' + encodeURIComponent(redirect) + '&response_type=token&scope=channel:manage:redemptions');

        if (document.location.hash && document.location.hash != '') {
            log('Checking for token');
            var parsedHash = new URLSearchParams(window.location.hash.slice(1));
            if (parsedHash.get('access_token')) {
                log('Got a token');
                processToken(parsedHash.get('access_token'));
            }
        }
		
		function getRandomIntInclusive(min, max) {
		  min = Math.ceil(min);
		  max = Math.floor(max);
		  return Math.floor(Math.random() * (max - min + 1)) + min;
		}
		
		function playRandomSound(){
			var soundnum = getRandomIntInclusive(10, 1009);
			var audio = new Audio(soundnum+'-Random Bit Crate_Feb2014.wav');
			audio.volume = .2;
			audio.play();
		}
		
		function getUrlParameter(name) {
		  const urlParams = new URLSearchParams(window.location.search);
		  return urlParams.get(name);
		}

        function log(message) {
            let p = document.createElement('div');
            document.getElementById('log').prepend(p);

            let tim = document.createElement('span');
            let t = [
                new Date().getHours(),
                new Date().getMinutes(),
                new Date().getSeconds()
            ]
            t.forEach((v, i) => {
                t[i] = v < 10 ? '0' + v : v;
            });
            tim.textContent = t.join(':');
            p.append(tim);

            let l = document.createElement('span');
            p.append(l);
            l.textContent = message;
        }

        function processToken(token) {
            access_token = token;

            fetch(
                'https://api.twitch.tv/helix/users',
                {
                    "headers": {
                        "Client-ID": client_id,
                        "Authorization": "Bearer " + access_token
                    }
                }
            )
                .then(resp => resp.json())
                .then(resp => {
                    socket_space = new initSocket(true);
                    // and build schnanaigans
                    socket_space.on('connected', (id) => {
                        log(`Connected to WebSocket with ${id}`);
                        session_id = id;
                        my_user_id = resp.data[0].id;

                        requestHooks(resp.data[0].id, my_user_id);
						
						// for pre-caching ALL of the redeems early on
						//addUserPreCache(my_user_id);
							
						//clear the scene for browser source use
						document.getElementById("bigcontainer").style.display = "none";
                    });

                    socket_space.on('session_keepalive', () => {
                        document.getElementById('keepalive').textContent = new Date();
                    });
					socket_space.on('channel.channel_points_custom_reward_redemption.add', ({ metadata, payload }) => {
    					let { event } = payload;
    					let { id , user_login , user_id , reward } = event;
    					
						console.log(`${user_login} has redeemed ${reward.title}`);
						log(`${user_login} has redeemed ${reward.title} ${id} ${reward.cost}`);
						getRedeemColor(my_user_id, `${reward.id}`)
						getUsersColor(`${user_id}`);
						
						document.getElementById("nome").style.color = "#fff"
						document.getElementById("nome").textContent = `${user_login}`
                    	document.getElementById("acao").style.color = "#fff"
						document.getElementById("acao").textContent = `${reward.title}`
						
					});
				})	
                .catch(err => {
                    console.log(err);
                    log('Error with Users Call');
                });
        }
		
        function getRedeemColor(broadcaster_id, redeem_id) {
            let url = new URL('https://api.twitch.tv/helix/channel_points/custom_rewards?broadcaster_id='+broadcaster_id+'&id='+redeem_id);
            //url.search = new URLSearchParams([['broadcaster_id', broadcaster_id]['id', redeem_id]]).toString();

            fetch(
                url,
                {
                    "headers": {
                        "Client-ID": client_id,
                        "Authorization": "Bearer " + access_token
                    }
                }
            )
                .then(resp => resp.json())
                .then(resp => {
                    log(`Got ${resp.data[0]} for ${broadcaster_id}`);
					console.dir(resp.data[0]);
                    document.getElementById("box").style.backgroundColor = `${resp.data[0].background_color}`
					document.getElementById("img").src = `${resp.data[0].image.url_4x}`
					
					hex = `${resp.data[0].background_color}`

					if( hexIsLightColor(hex) ) {
						document.getElementById("nome").style.color = "#112"
						document.getElementById("acao").style.color = "#112"
					} else {
						document.getElementById("nome").style.color = "#fff"
						document.getElementById("acao").style.color = "#fff"
					}
					
                })
                .catch(err => {
                    console.log(err);
                    log('Error with Users Call');
                });
        }

		function addUserPreCache(broadcaster_id) {
            let url = new URL('https://api.twitch.tv/helix/channel_points/custom_rewards');
            url.search = new URLSearchParams([['broadcaster_id', broadcaster_id]]).toString();

            fetch(
                url,
                {
                    "headers": {
                        "Client-ID": client_id,
                        "Authorization": "Bearer " + access_token
                    }
                }
            )
                .then(resp => resp.json())
                .then(resp => {
                    log(`Got ${resp.data} for ${broadcaster_id}`);
					console.dir(resp.data);
					
                })
                .catch(err => {
                    console.log(err);
                    log('Error with Users Call');
                });
        }
		
		function hexIsLightColor(hex){
			gray = parseInt(hex.substring(1, 3), 16) * 0.2126 + parseInt(hex.substring(3, 5), 16) * 0.7152 + parseInt(hex.substring(5, 7), 16) * 0.0722;
			console.log(gray);
			document.getElementById("box").style.backgroundColor = hex;
			return gray > 210 ? true : false;
		}
		
		function getUsersColor(theuserid) {
            let url = new URL('https://api.twitch.tv/helix/chat/color?user_id='+`${theuserid}`);
			log('https://api.twitch.tv/helix/chat/color?user_id='+`${theuserid}`);
            url.search = new URLSearchParams([['user_id', theuserid]]).toString();

            fetch(
                url,
                {
                    "headers": {
                        "Client-ID": client_id,
                        "Authorization": "Bearer " + access_token
                    }
                }
            )
                .then(resp => resp.json())
                .then(resp => {
                    log(`Got ${resp.data[0].color} for ${theuserid}`);
					redeemUserColor = `${resp.data[0].color}`
					//document.getElementById("nome").style.color = `${resp.data[0].color}`
					document.getElementById("box").style.boxShadow = '0 0 32px 32px '+`${resp.data[0].color}`
					
					const paramValue = getUrlParameter('bgcolor');
					log('bg color is '+paramValue);
					document.getElementById("box").style.backgroundColor = '#'+paramValue
					
					
					playRandomSound();
					playAnimation(0);
                })
                .catch(err => {
                    console.log(err);
                    log('Error with getUsersColor Call');
                });
        }

        function requestHooks(user_id, my_id) {
            let eventSubTypes = {
              //  'channel.update': { version: "1", condition: { broadcaster_user_id: user_id } },
              //  'channel.follow': { version: "2", condition: { broadcaster_user_id: user_id, moderator_user_id: my_id } },
                //inbound raid
              //  'channel.raid': { version: "1", condition: { to_broadcaster_user_id: user_id } },
    
              //  'stream.online': { version: "1", condition: { broadcaster_user_id: user_id } },
              //  'stream.offline': { version: "1", condition: { broadcaster_user_id: user_id } },
    
              //  'user.update': { version: "1", condition: { user_id: user_id } },
				//  'channel.channel_points_custom_reward.add': { version: "1", condition: { broadcaster_user_id: user_id } },
				//  'channel.channel_points_custom_reward.update': { version: "1", condition: { broadcaster_user_id: user_id } },
				  'channel.channel_points_custom_reward_redemption.add': { version: "1", condition: { broadcaster_user_id: user_id } },
				//  'channel.channel_points_custom_reward_redemption.update': { version: "1", condition: { broadcaster_user_id: user_id } }
            }
			
			
            
            log(`Spawn Topics for ${user_id}`);

            for (let type in eventSubTypes) {
                log(`Attempt create ${type} - ${user_id}`);
                let { version, condition } = eventSubTypes[type];

                spawnHook(type, version, condition);
            }
        }
        function spawnHook(type, version, condition) {
            fetch(
                'https://api.twitch.tv/helix/eventsub/subscriptions',
                {
                    "method": "POST",
                    "headers": {
                        "Client-ID": client_id,
                        "Authorization": "Bearer " + access_token,
                        'Content-Type': 'application/json'
                    },
                    "body": JSON.stringify({
                        type,
                        version,
                        condition,
                        transport: {
                            method: "websocket",
                            session_id
                        }
                    })
                }
            )
                .then(resp => resp.json())
                .then(resp => {
                    if (resp.error) {
                        log(`Error with eventsub Call ${type} Call: ${resp.message ? resp.message : ''}`);
                    } else {
                        log(`Created ${type}`);
                    }
                })
                .catch(err => {
                    console.log(err);
                    log(`Error with eventsub Call ${type} Call: ${err.message ? err.message : ''}`);
                });
        }

	
function playAnimation(direc) {
	document.getElementById("anchor").removeAttribute("style")
    document.getElementById("anchor").removeAttribute("class")
    document.getElementById("box").removeAttribute("class")
	
    const confettiWrapper = document.getElementById("confettianimation");
	confettiWrapper.innerHTML = '';
	confettiWrapper.classList.add("confetti-wrapper");

    void document.getElementById("box").offsetWidth;

    if (direc == 0) {
        /* console.log("play in"); */
		document.getElementById("confettianimation").style.display = "block";
        document.getElementById("anchor").classList.add("anchorAniIn")
        document.getElementById("box").classList.add("boxAniIn")
		
        // --- Confetti Generation Logic ---
        const confettiCount = 150;
        // Generate a color palette from the user's redeem color for a more professional look
        const baseColor = redeemUserColor || '#ff0000';
        const colors = [
            baseColor,
            // Function to lighten or darken the base color
            pSBC(0.4, baseColor),
            pSBC(-0.4, baseColor)
        ];

		for (let i = 0; i < confettiCount; i++) {
		  const confetti = document.createElement('div');
		  confetti.classList.add('confetti-piece');
          
          // Set random properties for each piece
		  confetti.style.left = `${Math.random() * 100}%`;
          confetti.style.width = `${Math.random() * 12 + 8}px`; // width from 8px to 20px
          confetti.style.height = `${Math.random() * 7 + 5}px`; // height from 5px to 12px
		  confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.opacity = '0';
          
          // Animation properties
          const duration = Math.random() * 3 + 4; // duration from 4s to 7s
          const delay = Math.random() * 1.5; // delay up to 1.5s
          confetti.style.animation = `confetti-fall ${duration}s cubic-bezier(0.25, 0.1, 0.25, 1) ${delay}s forwards`;

          // Set CSS variables for the keyframe animation
          confetti.style.setProperty('--rz', `${Math.random() * 1080 - 540}deg`); // Z-axis rotation
          confetti.style.setProperty('--ry', `${Math.random() * 1080 - 540}deg`); // Y-axis rotation for flutter effect

		  confettiWrapper.appendChild(confetti);
		}
		
    } else {
        /* console.log("play out"); */
        document.getElementById("anchor").classList.add("anchorAniOut")
        document.getElementById("box").classList.add("boxAniOut")
    }

    // Timer to hide the confetti wrapper after the longest animation could have finished
    timer3=window.setTimeout(
        function(){
            document.getElementById("confettianimation").style.display = "none";
        }, 8500); // Increased duration to match new confetti timings
	
    timer2=window.setTimeout(
        function(){
            document.getElementById("anchor").classList.add("anchorAniOut")
            document.getElementById("box").classList.add("boxAniOut")
        },7000);
	
    timer1=window.setTimeout(
        function(){
                document.getElementById("anchor").style.display = "none";
        },8000); 
}

// Helper function to calculate lighter/darker shades of a color
const pSBC=(p,c0,c1,l)=>{
    let r,g,b,P,f,t,h,i=parseInt,m=Math.round,a=typeof(c1)=="string";
    if(typeof(p)!="number"||p<-1||p>1||typeof(c0)!="string"||(c0[0]!='r'&&c0[0]!='#')||(c1&&!a))return null;
    if(!this.pSBCr)this.pSBCr=(d)=>{
        let n=d.length,x={};
        if(n>9){
            [r,g,b,a]=d=d.split(","),n=d.length;
            if(n<3||n>4)return null;
            x.r=i(r[3]=="a"?r.slice(5):r.slice(4)),x.g=i(g),x.b=i(b),x.a=a?parseFloat(a):-1
        }else{
            if(n==8||n==6||n<4)return null;
            if(n<6)d="#"+d[1]+d[1]+d[2]+d[2]+d[3]+d[3]+(n>4?d[4]+d[4]:"");
            d=i(d.slice(1),16);
            if(n==9||n==5)x.r=d>>24&255,x.g=d>>16&255,x.b=d>>8&255,x.a=m((d&255)/0.255)/1000;
            else x.r=d>>16,x.g=d>>8&255,x.b=d&255,x.a=-1
        }return x};
    h=c0.length>9,h=a?c1.length>9?true:c1=="c"?!h:false:h,f=this.pSBCr(c0),P=p<0,t=c1&&c1!="c"?this.pSBCr(c1):P?{r:0,g:0,b:0,a:-1}:{r:255,g:255,b:255,a:-1},p=P?-p:p,P=1-p;
    if(!f||!t)return null;
    if(l)r=m(P*f.r+p*t.r),g=m(P*f.g+p*t.g),b=m(P*f.b+p*t.b);
    else r=m((P*f.r**2+p*t.r**2)**0.5),g=m((P*f.g**2+p*t.g**2)**0.5),b=m((P*f.b**2+p*t.b**2)**0.5);
    a=f.a,t=t.a,f=a>=0||t>=0,a=f?a<0?t:t<0?a:a*P+t*p:0;
    if(h)return"rgb"+(f?"a(":"(")+r+","+g+","+b+(f?","+m(a*1000)/1000:"")+")";
    else return"#"+(4294967296+r*16777216+g*65536+b*256+(f?m(a*255):0)).toString(16).slice(1,f?undefined:-2)
}	
    </script>

</div></div>
<div class="confetti-wrapper" id="confettianimation"></div>
<div style="display: block" id="animation">
        <div style="display:none" id="anchor">
            <div id="box" class="">
                <img id="img" src="https://static-cdn.jtvnw.net/community-goal-images/default-2.png">
                <p id="nome">userid</p>
                <p id="acao">reward.title</p>
            </div>
        </div>
</div> 
</body></html>